<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Get Quote â€“ Sunbeam Transportation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8fafc;
      padding: 20px;
      margin: 0;
    }

    h1 {
      margin-bottom: 10px;
    }

    .form-group {
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 8px;
      font-size: 14px;
    }

    button {
      padding: 9px 14px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 8px;
    }

    #addStopBtn {
      background: #e5e7eb;
      border: none;
      margin-bottom: 10px;
    }

    #priceBox {
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
    }

    #map {
      height: 400px;
      margin-top: 10px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>

<h1>Get Quote</h1>

<div class="form-group">
  <input id="pickup" class="route-point" placeholder="Pickup address">
</div>

<div id="stopsContainer"></div>

<button id="addStopBtn">+ Add Stop</button>

<div class="form-group">
  <input id="dropoff" class="route-point" placeholder="Dropoff address">
</div>

<button onclick="calculate()">Calculate Price</button>
<button id="bookTripBtn" disabled>Book This Trip</button>

<div id="priceBox" class="hidden"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([33.4484, -112.0740], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers = [];
let lines = [];
let lastTripData = null;
let isQuoteValid = false;

let stopCount = 0;
const maxStops = 5;
const stopsContainer = document.getElementById("stopsContainer");

document.getElementById("addStopBtn").addEventListener("click", () => {
  if (stopCount >= maxStops) return;

  stopCount++;
  const input = document.createElement("input");
  input.placeholder = `Stop ${stopCount}`;
  input.className = "route-point stop";
  input.style.marginBottom = "8px";
  stopsContainer.appendChild(input);
});

async function geocode(address) {
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  const data = await res.json();
  if (!data.length) throw "Address not found";
  return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
}

function distanceMiles(a, b) {
  const R = 3958.8;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const x =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(a.lat * Math.PI / 180) *
    Math.cos(b.lat * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
}

async function calculate() {
  markers.forEach(m => map.removeLayer(m));
  lines.forEach(l => map.removeLayer(l));
  markers = [];
  lines = [];

  const pickupVal = pickup.value.trim();
  const dropoffVal = dropoff.value.trim();
  if (!pickupVal || !dropoffVal) {
    alert("Enter pickup and dropoff");
    return;
  }

  try {
    const inputs = document.querySelectorAll(".route-point");
    const points = [];

    for (const input of inputs) {
      if (input.value.trim()) {
        points.push(await geocode(input.value.trim()));
      }
    }

    let miles = 0;
    for (let i = 0; i < points.length - 1; i++) {
      miles += distanceMiles(points[i], points[i + 1]);
    }

    let price = 30;
    if (miles > 10) price += (miles - 10) * 2;

    const stopQty = Math.max(0, points.length - 2);
    const stopsFee = stopQty * 5;
    price += stopsFee;

    points.forEach(p => markers.push(L.marker([p.lat, p.lng]).addTo(map)));
    for (let i = 0; i < points.length - 1; i++) {
      lines.push(
        L.polyline(
          [[points[i].lat, points[i].lng], [points[i + 1].lat, points[i + 1].lng]],
          { color: 'orange', weight: 4 }
        ).addTo(map)
      );
    }

    map.fitBounds(points.map(p => [p.lat, p.lng]), { padding: [30, 30] });

    document.getElementById("priceBox").classList.remove("hidden");
    document.getElementById("priceBox").innerHTML = `
      Miles: ${miles.toFixed(2)}<br>
      Stops: ${stopQty} ($${stopsFee})<br>
      <b>Total: $${price.toFixed(2)}</b>
    `;

    const stops = [];
    document.querySelectorAll(".stop").forEach(input => {
      if (input.value.trim()) stops.push(input.value.trim());
    });

    lastTripData = {
      pickup: pickupVal,
      dropoff: dropoffVal,
      stops: stops,
      miles: miles.toFixed(2),
      price: price.toFixed(2)
    };

    isQuoteValid = true;
    document.getElementById("bookTripBtn").disabled = false;

  } catch (e) {
    alert(e);
  }
}

document.getElementById("bookTripBtn").addEventListener("click", () => {
  if (!isQuoteValid) return;
  localStorage.setItem("tripData", JSON.stringify(lastTripData));
  window.location.href = "../booking/index.html";
});
</script>

</body>
</html>