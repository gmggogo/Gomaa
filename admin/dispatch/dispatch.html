<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dispatch Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --gold:#d4af37;
  --dark:#111827;
  --gray:#e5e7eb;
}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f3f4f6;padding-top:85px}

/* HEADER */
.header{
  position:fixed;top:0;left:0;width:100%;height:85px;
  background:linear-gradient(90deg,#0f172a,#1f2937);
  color:#fff;display:flex;align-items:center;
  padding:0 25px;z-index:999;border-bottom:3px solid var(--gold)
}
.h-left{width:25%}
.h-center{width:50%;text-align:center}
.h-right{width:25%;text-align:right}
.btn{border:none;padding:6px 14px;border-radius:6px;font-weight:bold;cursor:pointer}
.gold{background:var(--gold)}
.green{background:#16a34a;color:#fff}
.blue{background:#2563eb;color:#fff}
.red{background:#dc2626;color:#fff}

.page{max-width:1500px;margin:auto;padding:20px}

/* TABLE */
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #d1d5db;padding:6px;font-size:13px;text-align:center}
th{background:#1f2933;color:#fff}
select{padding:4px;border-radius:5px}
</style>
</head>

<body>

<div class="header">
  <div class="h-left">
    <button class="btn gold" onclick="history.back()">← Back</button>
  </div>
  <div class="h-center">
    <div style="color:var(--gold);font-size:18px;font-weight:bold">
      Sunbeam Transportation
    </div>
    <div>Dispatch Board</div>
    <div id="adminName" style="font-size:12px;opacity:.8"></div>
  </div>
  <div class="h-right">
    <span id="clock"></span>
    <button class="btn gold" onclick="logout()">Logout</button>
  </div>
</div>

<div class="page">

  <div style="margin-bottom:10px">
    <button class="btn green" onclick="sendSelected()">Send Selected</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>✓</th>
        <th>Trip #</th>
        <th>Client</th>
        <th>Pickup</th>
        <th>Stops</th>
        <th>Dropoff</th>
        <th>Driver</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<script>
/* ================= CLOCK (AZ) ================= */
function updateClock(){
  document.getElementById("clock").innerText =
    new Date().toLocaleString("en-US",{
      timeZone:"America/Phoenix",
      hour:"2-digit",minute:"2-digit",
      month:"short",day:"2-digit"
    });
}
setInterval(updateClock,1000);updateClock();

/* ================= ADMIN ================= */
const admin = JSON.parse(localStorage.getItem("loggedAdmin")||"{}");
if(admin.name) adminName.innerText = admin.name;

/* ================= DATA ================= */
// الرحلات
let trips = JSON.parse(localStorage.getItem("companyTrips")) || [];
// السواقين من users
const users = JSON.parse(localStorage.getItem("users")) || [];
const drivers = users.filter(u => u.role === "driver" && u.active !== false);

// اللي داخل الديسبتش فقط
let dispatchTrips = trips.filter(t => t.inDispatch === true);

const tbody = document.getElementById("tbody");

/* ================= RENDER ================= */
function render(){
  tbody.innerHTML = "";

  dispatchTrips.forEach(t=>{
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="checkbox" class="chk"></td>
      <td>${t.tripNumber||""}</td>
      <td>${t.clientName||""}</td>
      <td>${t.pickup||""}</td>
      <td>${(t.stops||[]).join(" | ") || "-"}</td>
      <td>${t.dropoff||""}</td>

      <td>
        <select onchange="assignDriver('${t.tripNumber}',this.value)">
          <option value="">Select Driver</option>
          ${drivers.map(d=>`
            <option value="${d.id}"
              ${t.driverId===d.id?"selected":""}>
              ${d.name}
            </option>
          `).join("")}
        </select>
      </td>

      <td>
        <button class="btn blue" onclick="openMap('${t.pickup}')">Map</button>
        <button class="btn red" onclick="removeTrip('${t.tripNumber}')">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= ACTIONS ================= */
function assignDriver(tripNumber, driverId){
  if(!driverId) return;

  trips = trips.map(t=>{
    if(t.tripNumber === tripNumber){
      t.driverId = driverId;
      t.status = "Assigned";
    }
    return t;
  });

  localStorage.setItem("companyTrips",JSON.stringify(trips));
  dispatchTrips = trips.filter(t=>t.inDispatch===true);
}

function removeTrip(num){
  trips = trips.map(t=>{
    if(t.tripNumber===num){
      t.inDispatch = false;
      t.driverId = null;
    }
    return t;
  });
  localStorage.setItem("companyTrips",JSON.stringify(trips));
  dispatchTrips = trips.filter(t=>t.inDispatch===true);
  render();
}

function sendSelected(){
  const rows = [...document.querySelectorAll(".chk:checked")];
  if(!rows.length) return alert("No trips selected");

  rows.forEach(chk=>{
    const row = chk.closest("tr");
    const num = row.children[1].innerText;

    const trip = trips.find(t=>t.tripNumber===num);
    if(!trip.driverId){
      alert("Trip "+num+" has no driver");
      return;
    }

    const key = "driverTrips_"+trip.driverId;
    const inbox = JSON.parse(localStorage.getItem(key))||[];
    inbox.push({...trip,status:"Assigned"});
    localStorage.setItem(key,JSON.stringify(inbox));

    trip.status = "Sent";
  });

  localStorage.setItem("companyTrips",JSON.stringify(trips));
  alert("Trips sent");
}

/* ================= HELPERS ================= */
function openMap(addr){
  window.open("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(addr));
}
function logout(){
  localStorage.clear();
  location.href="../login.html";
}

/* ================= INIT ================= */
render();
</script>

</body>
</html>