<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirm Booking â€“ Sunbeam</title>

<style>
body{
  font-family:Arial;
  background:#f8fafc;
  margin:0;
  padding:15px;
}

.box{
  background:#fff;
  max-width:700px;
  margin:auto;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

h1{margin-bottom:15px}

label{
  display:block;
  margin-top:15px;
  font-size:13px;
  color:#374151;
}

input,textarea,select{
  width:100%;
  padding:8px;
  margin-top:5px;
  font-size:14px;
  box-sizing:border-box;
}

textarea{resize:none;min-height:60px}

.row{display:flex;gap:10px}
.row>div{flex:1}

button{
  padding:10px 14px;
  font-size:14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.confirm{background:#2563eb;color:#fff}
.recalc{background:#dc2626;color:#fff}

.error{border:2px solid #dc2626}
.error-text{color:#dc2626;font-size:12px;margin-top:4px}
.note{font-size:12px;color:#6b7280;margin-top:8px}
</style>
</head>
<body>

<div class="box">
<h1>Confirm Booking</h1>

<label>Pickup</label>
<input id="pickup" readonly>

<label>Stops</label>
<textarea id="stops" readonly></textarea>

<label>Dropoff</label>
<input id="dropoff" readonly>

<div class="row">
  <div>
    <label>Miles</label>
    <input id="miles" readonly>
  </div>
  <div>
    <label>Price ($)</label>
    <input id="price" readonly>
  </div>
</div>

<p class="note">
ðŸ”’ Addresses & price are locked.
</p>

<label>Passenger Name</label>
<input id="name">

<label>Phone</label>
<div class="row">
  <div style="max-width:110px">
    <select id="countryCode">
      <option value="+1">+1</option>
      <option value="+44">+44</option>
      <option value="+20">+20</option>
    </select>
  </div>
  <div>
    <input id="phone">
    <div id="phoneError" class="error-text"></div>
  </div>
</div>

<div class="row">
  <div>
    <label>Date</label>
    <input type="date" id="date">
  </div>
  <div>
    <label>Time</label>
    <input type="time" id="time">
  </div>
</div>

<div style="margin-top:25px;display:flex;justify-content:space-between">
  <button class="recalc" onclick="recalculate()">Recalculate</button>
  <button class="confirm" onclick="confirmBooking()">Confirm</button>
</div>
</div>

<script>
const tripData = JSON.parse(localStorage.getItem("tripData"));
if(!tripData){
  alert("No quote found");
  location.href="../getquote/index.html";
}

pickup.value  = tripData.pickup || "";
dropoff.value = tripData.dropoff || "";
miles.value   = tripData.miles || "";
price.value   = tripData.price || "";
stops.value   = (tripData.stops||[]).join("\n");

function minutesUntilTripAZ(dateStr,timeStr){
  const nowAZ = new Date(
    new Date().toLocaleString("en-US",{timeZone:"America/Phoenix"})
  );
  const tripAZ = new Date(
    new Date(`${dateStr}T${timeStr}`).toLocaleString("en-US",{timeZone:"America/Phoenix"})
  );
  return Math.floor((tripAZ-nowAZ)/60000);
}

function recalculate(){
  localStorage.removeItem("tripData");
  location.href="../getquote/index.html";
}

function confirmBooking(){
  phoneError.innerText="";
  let valid=true;

  if(!name.value.trim()){name.classList.add("error");valid=false}
  if(!date.value){date.classList.add("error");valid=false}
  if(!time.value){time.classList.add("error");valid=false}

  const digits=phone.value.replace(/\D/g,"");
  if(digits.length<7){phone.classList.add("error");phoneError.innerText="Invalid phone";valid=false}

  if(!valid)return;

  const minutesLeft=minutesUntilTripAZ(date.value,time.value);

  if(minutesLeft<=120){
    const ok=confirm("Booking within 120 minutes.\nEditing will not be allowed.\nContinue?");
    if(!ok)return;
  }

  const pendingBooking={
    type:"Individual",
    pickup:pickup.value,
    dropoff:dropoff.value,
    stops:tripData.stops||[],
    miles:tripData.miles,
    price:tripData.price,
    passenger:{
      name:name.value,
      phone:countryCode.value+digits
    },
    date:date.value,
    time:time.value,
    status:"Scheduled",
    createdAt:new Date().toISOString()
  };

  localStorage.setItem("pendingBooking",JSON.stringify(pendingBooking));
  location.href="./payment.html";
}
</script>

</body>
</html>