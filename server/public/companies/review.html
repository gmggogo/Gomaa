<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunbeam â€“ Review Trips</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f4f8fb;
  font-size:11px;
}

.container{
  padding:15px;
}

#searchBox{
  width:100%;
  padding:6px 8px;
  font-size:11px;
  border:1px solid #93c5fd;
  border-radius:6px;
  margin-bottom:15px;
}

/* ================= TABLE (DESKTOP) ================= */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th{
  background:#e0f2fe;
  padding:5px;
  font-size:10px;
  border:1px solid #e2e8f0;
}

td{
  padding:4px;
  border:1px solid #e2e8f0;
  text-align:center;
  font-size:10px;
}

/* ================= MOBILE CARD ================= */
.mobile-card{
  display:none;
  background:#fff;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  font-size:13px;
}

.mobile-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.mobile-label{
  color:#64748b;
  font-weight:600;
}

.mobile-value{
  text-align:right;
  font-weight:500;
  word-break:break-word;
}

.passed{
  background:#ffe5e5 !important;
  border-left:4px solid #dc2626;
}

/* ================= RESPONSIVE ================= */
@media(max-width:768px){

  table{
    display:none;
  }

  .mobile-card{
    display:block;
  }

}
</style>
</head>

<body>

<div class="container">

<input id="searchBox" placeholder="Search name / phone / trip #">

<div id="tripsContainer"></div>

</div>

<script>
/* ===============================
   API
================================ */
const API_URL = "/api/trips";

let trips = [];
const container = document.getElementById("tripsContainer");
const searchBox = document.getElementById("searchBox");

/* ===============================
   LOAD
================================ */
async function loadTrips(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    trips = Array.isArray(data) ? data : [];
  }catch{
    trips = [];
  }
}

/* ===============================
   SAVE
================================ */
async function saveTrips(){
  await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(trips)
  });
}

/* ===============================
   PASSED CHECK
================================ */
function isTripPassed(t){
  if(!t.tripDate || !t.tripTime) return false;
  const tripDT = new Date(`${t.tripDate}T${t.tripTime}`);
  if(isNaN(tripDT)) return false;
  return new Date() >= tripDT;
}

/* ===============================
   REMOVE AFTER 30 DAYS
================================ */
function isExpired30Days(t){
  if(!t.tripDate || !t.tripTime) return false;
  const tripDT = new Date(`${t.tripDate}T${t.tripTime}`);
  if(isNaN(tripDT)) return false;
  const diffDays = (new Date() - tripDT) / (1000*60*60*24);
  return diffDays >= 30;
}

/* ===============================
   SEARCH FILTER
================================ */
function filteredTrips(){
  if(!searchBox.value) return trips;

  const q = searchBox.value.toLowerCase();
  return trips.filter(t =>
    (t.tripNumber||"").toLowerCase().includes(q) ||
    (t.clientName||"").toLowerCase().includes(q) ||
    (t.clientPhone||"").includes(q)
  );
}

/* ===============================
   RENDER
================================ */
async function render(){

  trips = trips.filter(t => !isExpired30Days(t));
  await saveTrips();

  container.innerHTML = "";

  if(!trips.length){
    container.innerHTML = "<p>No trips found</p>";
    return;
  }

  /* ===== DESKTOP TABLE ===== */
  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>#</th>
      <th>Trip #</th>
      <th>Company</th>
      <th>Client</th>
      <th>Phone</th>
      <th>Pickup</th>
      <th>Dropoff</th>
      <th>Date</th>
      <th>Time</th>
      <th>Status</th>
    </tr>
  `;

  filteredTrips().forEach((t,i)=>{

    /* ==== DESKTOP ROW ==== */
    const tr = document.createElement("tr");
    if(isTripPassed(t)) tr.classList.add("passed");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${t.tripNumber||"-"}</td>
      <td>${t.company||"-"}</td>
      <td>${t.clientName||"-"}</td>
      <td>${t.clientPhone||"-"}</td>
      <td>${t.pickup||"-"}</td>
      <td>${t.dropoff||"-"}</td>
      <td>${t.tripDate||"-"}</td>
      <td>${t.tripTime||"-"}</td>
      <td>${t.status||"-"}</td>
    `;
    table.appendChild(tr);

    /* ==== MOBILE CARD ==== */
    const card = document.createElement("div");
    card.className = "mobile-card";
    if(isTripPassed(t)) card.classList.add("passed");

    card.innerHTML = `
      <div class="mobile-row">
        <div class="mobile-label">Trip #</div>
        <div class="mobile-value">${t.tripNumber||"-"}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Client</div>
        <div class="mobile-value">${t.clientName||"-"}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Phone</div>
        <div class="mobile-value">${t.clientPhone||"-"}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Pickup</div>
        <div class="mobile-value">${t.pickup||"-"}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Dropoff</div>
        <div class="mobile-value">${t.dropoff||"-"}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Date</div>
        <div class="mobile-value">${t.tripDate||"-"} ${t.tripTime||""}</div>
      </div>
      <div class="mobile-row">
        <div class="mobile-label">Status</div>
        <div class="mobile-value">${t.status||"-"}</div>
      </div>
    `;

    container.appendChild(card);
  });

  container.prepend(table);
}

/* ===============================
   INIT
================================ */
searchBox.addEventListener("input", render);

(async function(){
  await loadTrips();
  await render();
})();
</script>

</body>
</html>