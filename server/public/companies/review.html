<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SUNBEAM TRANSPORTATION â€“ Review</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:#f4f8fb;
}

/* HEADER */
.header{
  background:linear-gradient(90deg,#0f172a,#1e3a8a);
  color:#fff;
  padding:20px 50px;
}

.top-section{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logged-company{
  font-size:20px;
  font-weight:700;
  color:#facc15;
}

.greeting,.clock{
  font-size:13px;
  margin-top:4px;
}

.logo{ height:75px; }

.nav{
  display:flex;
  justify-content:center;
  gap:40px;
  background:#000;
  padding:12px 0;
  margin-top:20px;
}

.nav a{
  color:#fff;
  text-decoration:none;
  font-size:14px;
  padding:6px 16px;
  border-radius:8px;
}

.nav a.active{
  background:#facc15;
  color:#000;
  font-weight:700;
}

/* CONTENT */
.container{
  max-width:1400px;
  margin:auto;
  padding:35px 20px;
}

.date-title{
  margin-top:30px;
  font-weight:700;
  font-size:16px;
  color:#0f172a;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:10px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  border-radius:12px;
  overflow:hidden;
}

th,td{
  padding:8px;
  font-size:12px;
  border-bottom:1px solid #eee;
  text-align:left;
}

th{
  background:#0f172a;
  color:#fff;
}

tr:hover{ background:#f9fafb; }

.yellow{ background:#fff3cd !important; }
.red{ background:#ffcccc !important; }

.btn{
  padding:5px 10px;
  border:none;
  border-radius:6px;
  font-size:11px;
  cursor:pointer;
  margin-right:4px;
}

.confirm{ background:#22c55e; color:#000; }
.edit{ background:#3b82f6; color:#fff; }
.delete{ background:#64748b; color:#fff; }
.cancel{ background:#ef4444; color:#fff; }

@media(max-width:768px){
  .header{ padding:20px; }
  .top-section{ flex-direction:column; text-align:center; }
  .logo{ margin-top:15px; height:65px; }
  table{ font-size:10px; }
}
</style>
</head>

<body>

<div class="header">
  <div class="top-section">
    <div>
      <div class="logged-company" id="companyName"></div>
      <div class="greeting" id="greetingText"></div>
      <div class="clock" id="azDateTime"></div>
    </div>
    <img src="../assets/logo.png" class="logo">
  </div>

  <div class="nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="add-trip.html">Add Trip</a>
    <a href="review.html" class="active">Review</a>
    <a href="summary.html">Summary</a>
    <a href="taxes.html">Taxes</a>
  </div>
</div>

<div class="container" id="tripsContainer"></div>

<script>
window.addEventListener("DOMContentLoaded", () => {

  const API_URL="/api/trips";
  const HUB_URL="/api/trips-hub";
  const container=document.getElementById("tripsContainer");
  let trips=[];

  /* AUTH */
  let loggedCompany=null;
  try{ loggedCompany=JSON.parse(localStorage.getItem("loggedCompany")); }catch{}
  if(!loggedCompany){ location.href="company-login.html"; return; }
  document.getElementById("companyName").innerText=loggedCompany.name||"";

  /* GREETING */
  function setGreeting(){
    const h=new Date().getHours();
    let msg="";
    if(h<12) msg="Good Morning â˜€ï¸";
    else if(h<18) msg="Good Afternoon ðŸŒ¤";
    else msg="Good Evening ðŸŒ™";
    document.getElementById("greetingText").innerText=msg;
  }
  setGreeting();

  /* CLOCK */
  function updateClock(){
    document.getElementById("azDateTime").innerText=
      new Intl.DateTimeFormat("en-US",{
        timeZone:"America/Phoenix",
        year:"numeric",month:"short",day:"2-digit",
        hour:"2-digit",minute:"2-digit",second:"2-digit"
      }).format(new Date());
  }
  setInterval(updateClock,1000);
  updateClock();

  /* TIME HELPERS */
  function getAZNow(){
    return new Date(new Date().toLocaleString("en-US",{timeZone:"America/Phoenix"}));
  }

  function getTripDT(t){
    if(!t.tripDate||!t.tripTime) return null;
    return new Date(t.tripDate+"T"+t.tripTime);
  }

  function minutesToTrip(t){
    const dt=getTripDT(t);
    if(!dt) return null;
    return (dt-getAZNow())/60000;
  }

  /* LOAD */
  async function loadTrips(){
    try{
      const res=await fetch(API_URL);
      trips=await res.json();
      if(!Array.isArray(trips)) trips=[];
    }catch{ trips=[]; }
  }

  /* KEEP 30 DAYS */
  function keep30Days(){
    const now=new Date();
    trips=trips.filter(t=>{
      if(!t.createdAt) return true;
      const diff=(now-new Date(t.createdAt))/(1000*60*60*24);
      return diff<=30;
    });
  }

  /* GROUP BY CREATED DATE */
  function groupByCreated(){
    const groups={};
    trips.forEach(t=>{
      const d=new Date(t.createdAt||Date.now()).toLocaleDateString();
      if(!groups[d]) groups[d]=[];
      groups[d].push(t);
    });
    return groups;
  }

  /* RENDER */
  function render(){
    container.innerHTML="";
    const groups=groupByCreated();

    Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a))
    .forEach(date=>{

      const title=document.createElement("div");
      title.className="date-title";
      title.innerText=date;
      container.appendChild(title);

      const table=document.createElement("table");
      table.innerHTML=`
      <tr>
        <th>#</th>
        <th>Trip#</th>
        <th>Entered By</th>
        <th>Client</th>
        <th>Pickup</th>
        <th>Drop</th>
        <th>Stops</th>
        <th>Date</th>
        <th>Time</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>`;

      groups[date].forEach((t,i)=>{

        const tr=document.createElement("tr");
        const mins=minutesToTrip(t);

        if(mins!==null && mins>0 && mins<=120) tr.classList.add("yellow");
        if(mins!==null && mins<=0) tr.classList.add("red");

        let actions="";
        if(t.status==="Confirmed"){
          actions=`<button class="btn cancel" onclick="cancelTrip(${t.id||i})">Cancel</button>`;
        }else{
          actions=`
            <button class="btn edit" onclick="editTrip(${i})">Edit</button>
            <button class="btn delete" onclick="deleteTrip(${i})">Delete</button>
            <button class="btn confirm" onclick="confirmTrip(${i})">Confirm</button>`;
        }

        tr.innerHTML=`
          <td>${i+1}</td>
          <td>${t.tripNumber||""}</td>
          <td>${t.enteredBy||""}</td>
          <td>${t.clientName||""}</td>
          <td>${t.pickup||""}</td>
          <td>${t.dropoff||""}</td>
          <td>${Array.isArray(t.stops)?t.stops.join(" | "):""}</td>
          <td>${t.tripDate||""}</td>
          <td>${t.tripTime||""}</td>
          <td>${t.status||"Scheduled"}</td>
          <td>${actions}</td>
        `;
        table.appendChild(tr);
      });

      container.appendChild(table);
    });
  }

  /* ACTIONS */
  window.confirmTrip=async function(i){
    trips[i].status="Confirmed";
    await fetch(HUB_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(trips[i])});
    render();
  };

  window.cancelTrip=function(i){
    trips[i].status="Cancelled";
    render();
  };

  window.deleteTrip=function(i){
    if(confirm("Delete this trip?")){
      trips.splice(i,1);
      render();
    }
  };

  window.editTrip=function(i){
    alert("Edit mode here (logic already in your main JS)");
  };

  /* INIT */
  (async()=>{
    await loadTrips();
    keep30Days();
    render();
  })();

});
</script>

</body>
</html>